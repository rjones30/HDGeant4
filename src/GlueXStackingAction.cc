//
// GlueXStackingAction class implementation
//
// author: richard.t.jones at uconn.edu
// version: january 29, 2017

#include "GlueXStackingAction.hh"
#include "GlueXUserOptions.hh"
#include "GlueXUserTrackInformation.hh"

#include "G4Track.hh"
#include "G4ios.hh"
#include "G4ParticleTable.hh"
#include "TMath.h"

GlueXStackingAction::GlueXStackingAction()
{
   if (!(G4ParticleTable::GetParticleTable()->GetReadiness())) {
      G4String msg;
      msg =  " You are instantiating GlueXStackingAction BEFORE your\n";
      msg += "G4VUserPhysicsList is instantiated and assigned to ";
      msg += "G4RunManager.\nSuch an instantiation is prohibited by ";
      msg += "Geant4 version 8.0. To fix this problem,\n";
      msg += "please make sure that your main() instantiates ";
      msg += "G4VUserPhysicsList AND\nset it to G4RunManager before ";
      msg += "instantiating other user action classes\n";
      msg += "such as GlueXStackingAction.";
      G4Exception("GlueXStackingAction::GlueXStackingAction()",
                  "Event0031",FatalException,msg);
   }

   GlueXUserOptions *user_opts = GlueXUserOptions::GetInstance();
   if (user_opts == 0) {
      G4cerr << "Error in GlueXStackingAction constructor - "
             << "GlueXUserOptions::GetInstance() returns null, "
             << "cannot continue." << G4endl;
      exit(-1);
   }

   nosecondaries = 0;
   std::map<int,int> opt;
   if (user_opts->Find("NOSECONDARIES", opt)) {
      nosecondaries = (opt[1] != 0);
   }

   // quantum efficiency for H12700
   // defined for wavelength in the range [0, 1000] nm
   double fLambda[1000];
   double fEfficiency[1000] = {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.196823, 0.202016, 0.206993, 0.211762, 0.216329, 0.220700, 0.224884, 0.228885, 0.232711, 0.236366, 0.239858, 0.243192, 0.246373, 0.249408, 0.252301, 0.255058, 0.257683, 0.260182, 0.262560, 0.264822, 0.266971, 0.269013, 0.270951, 0.272791, 0.274535, 0.276189, 0.277756, 0.279239, 0.280643, 0.281971, 0.283227, 0.284413, 0.285534, 0.286592, 0.287590, 0.288531, 0.289419, 0.290255, 0.291043, 0.291785, 0.292484, 0.293142, 0.293762, 0.294345, 0.294894, 0.295412, 0.295899, 0.296358, 0.296791, 0.297200, 0.297585, 0.297950, 0.298296, 0.298624, 0.298935, 0.299231, 0.299514, 0.299784, 0.300043, 0.300291, 0.300531, 0.300763, 0.300988, 0.301206, 0.301420, 0.301629, 0.301835, 0.302038, 0.302238, 0.302437, 0.302636, 0.302833, 0.303031, 0.303230, 0.303429, 0.303630, 0.303832, 0.304037, 0.304244, 0.304453, 0.304666, 0.304881, 0.305099, 0.305321, 0.305545, 0.305774, 0.306005, 0.306240, 0.306478, 0.306720, 0.306964, 0.307212, 0.307463, 0.307717, 0.307973, 0.308232, 0.308493, 0.308756, 0.309022, 0.309288, 0.309557, 0.309826, 0.310096, 0.310367, 0.310637, 0.310908, 0.311178, 0.311447, 0.311715, 0.311981, 0.312245, 0.312507, 0.312766, 0.313022, 0.313274, 0.313522, 0.313766, 0.314005, 0.314238, 0.314466, 0.314688, 0.314903, 0.315111, 0.315311, 0.315504, 0.315688, 0.315863, 0.316029, 0.316185, 0.316331, 0.316466, 0.316590, 0.316703, 0.316804, 0.316893, 0.316968, 0.317031, 0.317080, 0.317114, 0.317135, 0.317140, 0.317130, 0.317105, 0.317063, 0.317005, 0.316931, 0.316839, 0.316729, 0.316602, 0.316457, 0.316292, 0.316109, 0.315907, 0.315686, 0.315444, 0.315182, 0.314900, 0.314598, 0.314274, 0.313929, 0.313563, 0.313175, 0.312765, 0.312333, 0.311878, 0.311402, 0.310902, 0.310379, 0.309834, 0.309265, 0.308673, 0.308057, 0.307418, 0.306755, 0.306068, 0.305357, 0.304622, 0.303863, 0.303080, 0.302273, 0.301442, 0.300586, 0.299706, 0.298802, 0.297874, 0.296921, 0.295944, 0.294943, 0.293918, 0.292869, 0.291796, 0.290699, 0.289579, 0.288434, 0.287266, 0.286075, 0.284860, 0.283623, 0.282362, 0.281078, 0.279772, 0.278443, 0.277093, 0.275720, 0.274325, 0.272908, 0.271470, 0.270012, 0.268532, 0.267031, 0.265510, 0.263970, 0.262409, 0.260829, 0.259229, 0.257611, 0.255974, 0.254319, 0.252646, 0.250956, 0.249248, 0.247524, 0.245782, 0.244025, 0.242252, 0.240464, 0.238661, 0.236843, 0.235011, 0.233165, 0.231306, 0.229433, 0.227549, 0.225652, 0.223743, 0.221823, 0.219892, 0.217951, 0.216000, 0.214040, 0.212070, 0.210092, 0.208105, 0.206111, 0.204110, 0.202102, 0.200087, 0.198067, 0.196041, 0.194011, 0.191976, 0.189937, 0.187894, 0.185849, 0.183801, 0.181750, 0.179699, 0.177646, 0.175592, 0.173538, 0.171484, 0.169431, 0.167380, 0.165330, 0.163282, 0.161236, 0.159194, 0.157155, 0.155120, 0.153089, 0.151063, 0.149042, 0.147027, 0.145018, 0.143016, 0.141020, 0.139032, 0.137052, 0.135080, 0.133116, 0.131162, 0.129217, 0.127281, 0.125356, 0.123442, 0.121538, 0.119645, 0.117765, 0.115896, 0.114039, 0.112195, 0.110364, 0.108547, 0.106743, 0.104953, 0.103177, 0.101415, 0.099669, 0.097937, 0.096221, 0.094521, 0.092836, 0.091168, 0.089515, 0.087880, 0.086261, 0.084659, 0.083074, 0.081506, 0.079956, 0.078424, 0.076910, 0.075413, 0.073935, 0.072475, 0.071034, 0.069611, 0.068206, 0.066821, 0.065454, 0.064106, 0.062776, 0.061466, 0.060175, 0.058903, 0.057650, 0.056416, 0.055201, 0.054005, 0.052829, 0.051671, 0.050532, 0.049413, 0.048312, 0.047230, 0.046166, 0.045122, 0.044096, 0.043088, 0.042099, 0.041128, 0.040175, 0.039241, 0.038324, 0.037424, 0.036542, 0.035678, 0.034831, 0.034000, 0.033187, 0.032389, 0.031609, 0.030844, 0.030096, 0.029363, 0.028645, 0.027943, 0.027255, 0.026583, 0.025924, 0.025280, 0.024650, 0.024033, 0.023430, 0.022840, 0.022262, 0.021697, 0.021144, 0.020603, 0.020073, 0.019555, 0.019048, 0.018551, 0.018065, 0.017588, 0.017122, 0.016665, 0.016217, 0.015777, 0.015346, 0.014924, 0.014509, 0.014102, 0.013702, 0.013310, 0.012924, 0.012544, 0.012171, 0.011803, 0.011442, 0.011085, 0.010734, 0.010388, 0.010047, 0.009710, 0.009377, 0.009048, 0.008724, 0.008403, 0.008085, 0.007772, 0.007461, 0.007154, 0.006850, 0.006548, 0.006250, 0.005955, 0.005663, 0.005374, 0.005087, 0.004804, 0.004523, 0.004246, 0.003972, 0.003701, 0.003434, 0.003171, 0.002911, 0.002656, 0.002405, 0.002159, 0.001918, 0.001682, 0.001453, 0.001229, 0.001013, 0.000803, 0.000602, 0.000409, 0.000225, 0.000051, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000};

   for(Int_t i=0; i<1000; i++){
     fLambda[i] = i;
   }

   fRand = new TRandom();
   fDetEff = new TGraph(1000,fLambda, fEfficiency);
   
}

GlueXStackingAction::~GlueXStackingAction()
{}

G4ClassificationOfNewTrack GlueXStackingAction::ClassifyNewTrack(
                                                const G4Track *aTrack)
{
   // Determine what to do with this secondary, which has just been
   // made into a G4Track object and needs to be classified as follows.
   //
   //    enum G4ClassificationOfNewTrack
   //    {
   //      fUrgent,    // put into the urgent stack
   //      fWaiting,   // put into the waiting stack
   //      fPostpone,  // postpone to the next event
   //      fKill       // kill without stacking
   //    };
   //
   //    The parent_ID of the track indicates the origin of it.
   //                
   //    G4int parent_ID = aTrack->get_parentID();
   //   
   //      parent_ID = 0 : primary particle
   //                > 0 : secondary particle
   //                < 0 : postponed from the previous event

   if (nosecondaries && aTrack->GetParentID() != 0)
      return fKill;

   // apply detection efficiency for the DIRC at production stage:
   G4String ParticleName = aTrack->GetDynamicParticle()->GetParticleDefinition()->GetParticleName();
   if(aTrack->GetParentID() > 0){ // particle is secondary
     if(ParticleName == "opticalphoton"){
       Double_t wavelength = 197.0*2.0*TMath::Pi()/(aTrack->GetMomentum().mag()*1.0E6);
       Double_t ra = fRand->Uniform(0.,1.);
       if(ra > fDetEff->Eval(wavelength)){
	 return fKill;
       }
     }
   }
   
   return fUrgent;
}

void GlueXStackingAction::NewStage()
{
   // This method is called by G4StackManager when the urgentStack
   // becomes empty and contents in the waitingStack are transtered
   // to the urgentStack. Note that this method is not called at the
   // begining of each event, see "PrepareNewEvent" for that.
   //
   // In case re-classification of the stacked tracks is needed,
   // use the following method to request to G4StackManager.
   //
   //    stackManager->ReClassify();
   //
   // All of the stacked tracks in the waitingStack will be re-classified 
   // by "ClassifyNewTrack" method. To abort current event, do
   //
   //    stackManager->clear();
   //
   // Note that this way is valid and safe only for the case it is called
   // from this user class. The more global way of event abortion is
   //
   //    G4UImanager * UImanager = G4UImanager::GetUIpointer();
   //    UImanager->ApplyCommand("/event/abort");
}

void GlueXStackingAction::PrepareNewEvent()
{
   // This method is called by G4StackManager at the begining of each event.
   // Be careful that the urgentStack and the waitingStack of G4StackManager
   // are empty at this moment, because this method is called before 
   // accepting primary particles. Also, note that the postponeStack of
   // G4StackManager may have some postponed tracks.
}
